# -*- coding: utf-8 -*-
"""Get dataset from API of TMDb-Liao_week10.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/16MFLYqL566D3hyZA-FwtH5HXvJVduGGT
"""

# pip install imdbpy

# pip install wget

# Commented out IPython magic to ensure Python compatibility.
import urllib.request
import requests
import json
import imdb
import time
import itertools
import wget
import os
import tmdbsimple as tmdb
import numpy as np
import random
import matplotlib
import matplotlib.pyplot as plt
# %matplotlib inline
import seaborn as sns
import pickle as pkl

api_key = 'cca7512b963db8aa84ed7e1abe3be199' 
url = 'https://api.themoviedb.org/3/movie/550?api_key=cca7512b963db8aa84ed7e1abe3be199'
data = urllib.request.urlopen(url).read()
dataDict = json.loads(data)

poster_folder='posters_final/'
if poster_folder.split('/')[0] in os.listdir('./'):
    print('Folder already exists')
else:
    os.mkdir('./'+poster_folder)

tmdb.API_KEY = api_key 
search = tmdb.Search()

def get_movie_id_tmdb(movie):
    response = search.movie(query=movie)
    movie_id=response['results'][0]['id']
    return movie_id

def get_movie_info_tmdb(movie):
    response = search.movie(query=movie)
    id=response['results'][0]['id']
    movie = tmdb.Movies(id)
    info=movie.info()
    return info

def get_movie_genres_tmdb(movie):
    response = search.movie(query=movie)
    id=response['results'][0]['id']
    movie = tmdb.Movies(id)
    genres=movie.info()['genres']
    return genres

def get_movie_overview_tmdb(movie):
    response = search.movie(query=movie)
    id=response['results'][0]['id']
    movie = tmdb.Movies(id)
    overview=movie.info()['overview']
    return genres

"""**Popular** **movie**"""

all_movies=tmdb.Movies()
top_movies=all_movies.popular()

print(len(top_movies['results']))
popular_movs=top_movies['results']

"""Obtain Top 10,000 popular movies from TMDb"""

all_movies=tmdb.Movies()
top10000_movies=[]
print('Pulling movie list, Please wait...')
for i in range(1,501):
    if i%15==0:
        time.sleep(7)
    movies_on_this_page=all_movies.popular(page=i)['results']
    top10000_movies.extend(movies_on_this_page)
len(top10000_movies)
f3=open('movie_list_week10.pckl','wb')
pickle.dump(top10000_movies,f3)
f3.close()
print('Done!')

f3=open('movie_list_week10.pckl','rb')
top10000_movies_week10=pickle.load(f3)
f3.close()

len(top10000_movies_week10)

import pandas as pd
with open("movie_list_week10.pckl", "rb") as f:
    object = pkl.load(f)
    
df = pd.DataFrame(object)
df.to_csv(r'top10000_movies_week10.csv')

with open('top10000_movies_week10.csv', 'r') as f:
    print(len(f.readlines()))

import pandas as pd

df = pd.read_csv('top10000_movies_week10.csv', index_col=None, header=0, engine='python' )

data = df.values

colnames = df.columns
colnames

df.to_csv('train_top10000_week10.csv', columns=['title', 'overview', 'genre_ids', 'id'])

with open('train_top10000_week10.csv', 'r') as f:
    print(len(f.readlines()))

"""***Upcoming movie***"""

all_movies=tmdb.Movies()
upcoming_movies=all_movies.upcoming()

print(len(upcoming_movies['results']))
upcoming_movs=top_movies['results']

all_movies=tmdb.Movies()
upcoming1000_movies=[]
print('Pulling movie list, Please wait...')
for i in range(1,51):
    if i%15==0:
        time.sleep(7)
    movies_on_this_page=all_movies.upcoming(page=i)['results']
    upcoming1000_movies.extend(movies_on_this_page)
len(upcoming1000_movies)
f4=open('upcoming_movie_list_week10.pckl','wb')
pickle.dump(upcoming1000_movies,f4)
f4.close()
print('Done!')

f4=open('upcoming_movie_list_week10.pckl','rb')
upcoming1000_movies_week10=pickle.load(f4)
f4.close()

len(upcoming1000_movies_week10)

"""**Only 400+ upcoming movies for week10**"""

with open("upcoming_movie_list_week10.pckl", "rb") as f:
    object = pkl.load(f)
    
df = pd.DataFrame(object)
df.to_csv(r'upcoming_movies_week10.csv')

# with open('upcoming_movies_week10.csv', 'r') as f:
#     print(len(f.readlines()))

len(upcoming1000_movies_week10)

df = pd.read_csv('upcoming_movies_week10.csv', index_col=None, header=0, engine='python')
data = df.values

df.to_csv('train_upcoming_week10.csv', columns=['title', 'overview', 'genre_ids', 'id'])

with open('train_upcoming_week10.csv', 'r') as f:
    print(len(f.readlines()))