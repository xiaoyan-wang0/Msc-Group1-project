# -*- coding: utf-8 -*-
"""Get dataset from API of TMDb-Liao.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/16MFLYqL566D3hyZA-FwtH5HXvJVduGGT
"""

# Commented out IPython magic to ensure Python compatibility.
import urllib.request
import requests
import json
import imdb
import time
import itertools
import wget
import os
import tmdbsimple as tmdb
import numpy as np
import random
import matplotlib
import matplotlib.pyplot as plt
# %matplotlib inline
import seaborn as sns
import pickle

api_key = 'cca7512b963db8aa84ed7e1abe3be199' 
url = 'https://api.themoviedb.org/3/movie/550?api_key=cca7512b963db8aa84ed7e1abe3be199'
data = urllib.request.urlopen(url).read()
dataDict = json.loads(data)

poster_folder='posters_final/'
if poster_folder.split('/')[0] in os.listdir('./'):
    print('Folder already exists')
else:
    os.mkdir('./'+poster_folder)

tmdb.API_KEY = api_key 
search = tmdb.Search()

def get_movie_id_tmdb(movie):
    response = search.movie(query=movie)
    movie_id=response['results'][0]['id']
    return movie_id

def get_movie_info_tmdb(movie):
    response = search.movie(query=movie)
    id=response['results'][0]['id']
    movie = tmdb.Movies(id)
    info=movie.info()
    return info

def get_movie_genres_tmdb(movie):
    response = search.movie(query=movie)
    id=response['results'][0]['id']
    movie = tmdb.Movies(id)
    genres=movie.info()['genres']
    return genres

def get_movie_overview_tmdb(movie):
    response = search.movie(query=movie)
    id=response['results'][0]['id']
    movie = tmdb.Movies(id)
    overview=movie.info()['overview']
    return genres

all_movies=tmdb.Movies()
top_movies=all_movies.popular()

print(len(top_movies['results']))
popular_movs=top_movies['results']

"""Obtain Top 10,000 popular movies from TMDb"""

all_movies=tmdb.Movies()
top10000_movies=[]
print('Pulling movie list, Please wait...')
for i in range(1,501):
    if i%15==0:
        time.sleep(7)
    movies_on_this_page=all_movies.popular(page=i)['results']
    top10000_movies.extend(movies_on_this_page)
len(top10000_movies)
f3=open('movie_list.pckl','wb')
pickle.dump(top10000_movies,f3)
f3.close()
print('Done!')

f3=open('movie_list.pckl','rb')
top10000_movies=pickle.load(f3)
f3.close()

len(top10000_movies)

import pandas as pd
with open("movie_list.pckl", "rb") as f:
    object = pkl.load(f)
    
df = pd.DataFrame(object)
df.to_csv(r'top10000_movies.csv')

with open('top10000_movies.csv', 'r') as f:
    print(len(f.readlines()))
# Why the lenth change?????

import pandas as pd

df = pd.read_csv('top10000_movies.csv', index_col=None, header=0, engine='python' )

data = df.values

colnames = df.columns
colnames

df.to_csv('train_data_TMDb.csv', columns=['title', 'overview', 'genre_ids', 'id'])

with open('train_data_TMDb.csv', 'r') as f:
    print(len(f.readlines()))